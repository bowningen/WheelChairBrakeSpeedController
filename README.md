く<div id="top"></div>

# WheelChairBrakeSpeedController

##### v1.0.2 / v2.0.0

## 目次

1. [概要](#概要)
2. [プロジェクト名](#プロジェクト名)
3. [詳細](#詳細)
4. [開発環境](#開発環境)
5. [実行方法](#実行方法)
6. [設定項目の一覧](#設定項目の一覧)
7. [トラブルシューティング](#トラブルシューティング)
8. [諸注意](#諸注意)
9. [更新履歴](#更新履歴)


## 概要

### v1
本プログラムはLinux版Python3系向けです。

Arduino2台とシリアル通信を行い、片方に接続しておいたホール素子(あるいは他のセンサー)からの電圧が変動する間隔から物体の回転速度を算出し、その速度に応じてもう一台のArduinoに接続したサーボモーターを制御するプログラムです。

### v2
本プログラムはArduino向けです。(開発に用いたボードはArduino CHIBIKKOです)

Arduinoに1台で、接続したホール素子(あるいはほかのセンサー)からの電圧が変動する間隔から物体の回転速度を算出し、その速度に応じてモータードライバーICの制御を行い、その先に接続したDCモーターやステッピングモーターを制御するプログラムです。
いくつかスイッチを取り付けた時の割り込み処理を置いていますので、自動と手動を両立したシステムを構築していただくことが可能です。
また、異常な動作に対する対策や処理も多数行っておりますので、安全にご使用いただけます。


応用することでホール素子を用いての様々な物体の速度を計測使用していただくことが可能です。

##### ※本プログラムは2024年1月に実験(Ⅱ)を行った時のプログラム(以下v1)のみ公開しており、2024年度に実験(Ⅲ)(Ⅳ)(Ⅴ)を行った時のプログラム(以下v2)は諸申請の関係上、現在公開しておりません。


## 使用技術一覧
<p style="display: inline">
  <img src="https://img.shields.io/badge/-Python-F2C63C.svg?logo=python&style=for-the-badge">
  <img src="https://img.shields.io/badge/-Arduino-00979D.svg?logo=arduino&style=for-the-badge">
</p>


## プロジェクト名

ホール素子を用いた介助式車椅子の自動速度制御装置の開発(奈良高等学校 2024)

<!-- プロジェクトについて -->

## プロジェクトについて(概要)

私たちは、車椅子が斜面を下る際のスピード加速による危険性に着目した。
最近は、自動ブレーキ付きの車椅子も存在しているが、後付けをすることができ、より簡易的で安価な資材で作れる自動ブレーキをつけることはできないかと考えた。
そこでホール効果を用いて車椅子の速度を測定し、それに応じてかける強さを変えることができる自動ブレーキを試作した。

  <p align="left">
    <br />
    <!-- プロジェクト詳細にBacklogのWikiのリンク -->
    <a href="https://www.e-net.nara.jp/hs/nara/index.cfm/1,3355,78,194,html">公開時の発表会はこちら<strong> »</strong></a>
    <br />
    <br />

## 詳細

### v1

お使いの環境(PCあるいはRaspberry Pi)にpyserialをインストールして、config.iniのarduino1,arduino2をお使いのArduinoそれぞれ(1はホール素子側、2はモーター側)のシリアルポート番号に設定します。(ls /dev/tty*)

各パーツは使用環境に合わせたものを使用していただき、使用したパーツに合わせて配線やプログラムの設定値変更を行ってください。

プログラムも使用する環境に合わせたものに書き換えてそれぞれに入れておき、その後実行してください。

※v2.0.0でArduino単体で動くものの公開予定(2024 10/23追記：現在諸申請を行っているため公開日未定)

### v2

お使いの環境にArduino IDE(v1/v2)をインストールして使用するボードの書き込み環境を構築してください。

各パーツは使用環境に合わせたものを使用していただき、使用したパーツに合わせて配線やプログラムの設定値変更を行ってください。

プログラムも使用する環境に合わせたものに書き換えてそれぞれに入れておき、その後実行してください。


## 開発環境

## v1.x.x
| OS　　　　　　　　　  | バージョン |
| --------------------- | ---------- |
| Ubuntu                | 22.04.3    |

| 言語・フレームワーク  | バージョン |
| --------------------- | ---------- |
| Python                | 3.10.12    |
| pyserial              | 3.5        |
| Arduino IDE           | 1.8.18     |
| servo                 | 1.2.1      |

## v2.x.x
| OS　　　　　　　　　  | バージョン |
| --------------------- | ---------- |
| Windows11                | 23H2(Build:22631.4317)    |

| 言語・フレームワーク  | バージョン |
| --------------------- | ---------- |
| Arduino IDE           | 1.8.18     |


## 必須ライブラリ

### v1
・pyserial (Python)

・servo (Arduino)

### v2
・なし
(stdio.hとstdlib.hをインクルードしている行をコメントアウトしていますが、使用したボード固有のものか何かで、書いてなくてもエラーはないことからなくても大丈夫だと思われます。)

## 開発/実行環境構築

### v1
あらかじめお使いのPCにPythonとArduino IDEをインストール、その後、各モジュールの最新版をpip等でインストールしてください。

なお、servoライブラリはArduino IDE側の「ライブラリの管理」からインストールしてください。

### v2
お使いのPCにArduino IDEをインストールし、使用するボードに応じた書き込み環境を構築してください。

## 実行方法

### v1
初めにArduinoを二台用意し、それぞれに同梱のinoファイルを書き込んでください。(環境によってはservoライブラリを追加でダウンロードする必要があります。)

その後、hlonlyを書き込んだものにはホール素子を、mtonlyを書き込んだものにはサーボモーターを適切に接続し、それぞれPythonの実行環境が存在するPCに接続します。

config.iniを開き、arduino1、arduino2をお使いのArduinoそれぞれ(1はホール素子側、2はモーター側)のシリアルポート番号に設定します。

(ls /dev/tty*)の実行でポート検索がかけられます。(この時、permission deniedとなる場合は、ユーザー等に対して権限の付与を行ってください。)

config.iniの他の値も設定項目の一覧
を参考にお使いの環境に合わせて設定を行ってください。

その後、final_final.pyのあるディレクトリに移動し、py final_final.py(環境によっては python3 final_final.py)等で実行してください。


なお、Final_Last.pyは現在動きません。
後のバージョンで修正予定です。


※現在のバージョンのファイルでは実行時にエラーが出ることが多いですが、シリアル通信関連で例外が発生していることがほとんどなので、何度かCtrl+Zで強制終了して再実行を繰り返していただくと動作します。（v1.1.0で修正予定）


## 設定項目の一覧

### v1

### ・config.ini
| 変数名                 | 役割                                      | デフォルト値                       |
| ---------------------- | ----------------------------------------- | ---------------------------------- |
| ARDUINO1               | Arduino(センサーを取り付けたもの) に割り当てられているポート | /dev/ttyACM0                       |
| ARDUINO2               | Arduino(モーターを取り付けたもの) に割り当てられているポート | /dev/ttyUSB0                       |
| RESULT                 | 各種情報の出力先(未使用) (※1)                           | result.txt                         |
| HOLE1                  | ホール素子1つ目の監視ピン(未使用)                         | 15                                 |
| HOLE2                  | ホール素子2つ目の監視ピン(未使用)                         | 16                                 |
| SERV1                  | モーターの名前1 (※2)                                   | L                                  |
| SERV2                  | モーターの名前2 (※2)                                   | R                                  |
| gp_outL                | モーター制御信号出力ピン1 (※3)                          |  7                                 |
| gp_outR                | モーター制御信号出力ピン1 (※3)                          | 11                                 |
| TIRE                   | 速度を計測するタイヤ(あるいは円盤)が何インチであるか         | 16                                 |
| MUG_NUM                | 速度を計測するタイヤ(あるいは円盤)につけた磁石の数          | 4                                  |
| VTE_OFF                | 磁石が接近していない状態でのホール電圧                     | 2.28                               |
| VTE_ERROR              | 磁石が接近していない状態での許容される電圧のブレの範囲       | 0.2                                |
| POS_MIN                | ブレーキOFF状態でのモーターの角度(未使用) (※4)            | 80                                 |
| POS_MAX                | フルブレーキ状態でのモーターの角度(未使用) (※4)           | 120                                |
| POS_MINL               | ブレーキOFF状態でのモーター1の角度                        | 90                                 |
| POS_MAXL               | フルブレーキ状態でのモーター1の角度                       | 110                                |
| POS_MINR               | ブレーキOFF状態でのモーター2の角度                        | 95                                 |
| POS_MAXR               | フルブレーキ状態でのモーター2の角度                       | 40                                 |
| minSP                  | ブレーキが作動開始する最小の速さ                           | 0.4                                |
| maxSP                  | ブレーキが全力でかかる...つまり最大の速さ                   | 2.0                                |



##### ※1 : v1.1.0で実装予定

##### ※2 : Raspberry Piを用いて制御する場合に変数に用いる名前として指定します。現在Raspberry Pi側でのモーターの動作の実装はしておりません。(Arduinoを使用してください)(v1.2.0で実装予定)

##### ※3 : Raspberry Piを用いて制御する場合に出力ピンとして指定します。現在Raspberry Pi側でのモーターの動作の実装はしておりません。(Arduinoを使用してください)(v1.2.0で実装予定)

##### ※4 : 左右でモーターの角度を同じにしていた時のものです。現在は左右で別の角度を指定できるようになったため、未使用となっております。


### ・holeRead_MTOnly.ino
### ・holeRead_HlOnly.ino

setup関数内の指定ピンをお手元の環境に合わせて変更してください。


### v2
###### 追記予定です

### ・main_chibikko.ino
| 変数名                 | 役割                                      | デフォルト値                       |
| ---------------------- | ----------------------------------------- | ---------------------------------- |
| HOLE1_POW | ホール素子_1用の電源出力ピンの指定(※1) | 12 |
| HOLE2_POW | ホール素子_2用の電源出力ピンの指定(※1) | 12 |
| HOLE1_READ | ホール素子_1用の電圧監視ピン(アナログ入力)の指定 | 14 |
| HOLE2_READ | ホール素子_2用の電圧監視ピン(アナログ入力)の指定 | 15 |
| R_F | MOTOR_R回転用スイッチ1用ON/OFF監視ピンの指定(※2) | 2 |
| R_R | MOTOR_R回転用スイッチ2用ON/OFF監視ピンの指定(※2) | 3 |
| L_F | MOTOR_L回転用スイッチ1用ON/OFF監視ピンの指定(※2) | 4 |
| L_R | MOTOR_L回転用スイッチ2用ON/OFF監視ピンの指定(※2) | 5 |
| MODE_SW | モード切替用スイッチ(自動/使用者手動⇔介助時のみブレーキ介助)用ON/OFF監視ピンの指定(※3)(※4) | 5 |
| R_MOTOR_OUT1 | MOTOR_R側モータードライバーへの入力用ピン1の指定 | 10 |
| R_MOTOR_OUT2 | MOTOR_R側モータードライバーへの入力用ピン2の指定 | 11 |
| L_MOTOR_OUT1 | MOTOR_L側モータードライバーへの入力用ピン1の指定 | 12 |
| L_MOTOR_OUT2 | MOTOR_L側モータードライバーへの入力用ピン2の指定 | 13 |
| RETURN | RETURNスイッチ用ON/OFF監視ピンの指定(※3) | 8 |
| STOP | STOPスイッチ用ON/OFF監視ピンの指定(※3) | 8 |
| HOLE1_V | ホール素子1のホール電圧が格納される変数(double) | 0.00 |
| HOLE2_V | ホール素子2のホール電圧が格納される変数(double) | 0.00 |
| HOLEx_V | ホール素子のホール電圧がAnalogRead()からの返り値の1024段階で格納される変数(double) | 0.00 |
| A_TIME | フルブレーキ状態でのモーター2の角度                       | 40                                 |
| D_TIME1 | ブレーキが作動開始する最小の速さ                           | 0.4                                |
| D_TIME2 | ブレーキが全力でかかる...つまり最大の速さ                   | 2.0                                |
| C_TIME | Arduino(センサーを取り付けたもの) に割り当てられているポート | /dev/ttyACM0                       |
| SP_N | Arduino(モーターを取り付けたもの) に割り当てられているポート | /dev/ttyUSB0                       |
| SP_N_LAST | 各種情報の出力先(未使用) (※1)                           | result.txt                         |
| SP_N_LAST2 | ホール素子1つ目の監視ピン(未使用)                         | 15                                 |
| SP_N_CK | ホール素子2つ目の監視ピン(未使用)                         | 16                                 |
| SP_N_PUSH | モーターの名前1 (※2)                                   | L                                  |
| TIRE | モーターの名前2 (※2)                                   | R                                  |
| MAG_NUM | モーター制御信号出力ピン1 (※3)                          |  7                                 |
| DIST | モーター制御信号出力ピン1 (※3)                          | 11                                 |
| VTE_OFF | 速度を計測するタイヤ(あるいは円盤)が何インチであるか         | 16                                 |
| VTE_ERROR | 速度を計測するタイヤ(あるいは円盤)につけた磁石の数          | 4                                  |
| IR | 磁石が接近していない状態でのホール電圧                     | 2.28                               |
| IL | 磁石が接近していない状態での許容される電圧のブレの範囲       | 0.2                                |
| ct | ブレーキOFF状態でのモーターの角度(未使用) (※4)            | 80                                 |
| CC_L | フルブレーキ状態でのモーターの角度(未使用) (※4)           | 120                                |
| CC_R | ブレーキOFF状態でのモーター1の角度                        | 90                                 |
| DeltaT | フルブレーキ状態でのモーター1の角度                       | 110                                |
| wl | ブレーキOFF状態でのモーター2の角度                        | 95                                 |
| SP_OUT_VALUE | フルブレーキ状態でのモーター2の角度                       | 40                                 |
| MODE | ブレーキが作動開始する最小の速さ                           | 0.4                                |
| SP_Need | ブレーキが全力でかかる...つまり最大の速さ                   | 2.0                                |
| R_TIME | Arduino(センサーを取り付けたもの) に割り当てられているポート | /dev/ttyACM0                       |
| START_TIME | Arduino(モーターを取り付けたもの) に割り当てられているポート | /dev/ttyUSB0                       |
| Release | 各種情報の出力先(未使用) (※1)                           | result.txt                         |
| END_TIME | ホール素子1つ目の監視ピン(未使用)                         | 15                                 |
| OVER_TIME | ホール素子2つ目の監視ピン(未使用)                         | 16                                 |
| P_TIME | モーターの名前1 (※2)                                   | L                                  |
| UPDATE | モーターの名前2 (※2)                                   | R                                  |
| BKPOS | モーター制御信号出力ピン1 (※3)                          |  7                                 |
| BKSTEP | モーター制御信号出力ピン1 (※3)                          | 11                                 |
| BKOVER | 速度を計測するタイヤ(あるいは円盤)が何インチであるか         | 16                                 |
| HL1_LAST | 速度を計測するタイヤ(あるいは円盤)につけた磁石の数          | 4                                  |
| PN | 磁石が接近していない状態でのホール電圧                     | 2.28                               |
| i | 磁石が接近していない状態での許容される電圧のブレの範囲       | 0.2                                |
| p | ブレーキOFF状態でのモーターの角度(未使用) (※4)            | 80                                 |
| count | フルブレーキ状態でのモーターの角度(未使用) (※4)           | 120                                |
| C_VTE | ブレーキOFF状態でのモーター1の角度                        | 90                                 |
| tr | フルブレーキ状態でのモーター1の角度                       | 110                                |



##### ※1 : 5Vや3.3Vピンから直接取ることも可能です。


## トラブルシューティング

### v1

### AttributeError: module 'serial' has no attribute 'Serial'
pyserialではなくserialをインストールしている可能性があります。
serialをインストールしている、あるいは両方をインストールしている場合、serialをアンインストールしてください。

### No such file or directory: '/dev/tty****'
指定しているシリアルポートが間違っている可能性があります。
Arduinoを抜き差ししつつ" ls /dev/tty* "を実行して特定を行ったうえで、config.iniに記述してください。

### 2.2.41がfloatに直せない等のエラーが出ている
既知のバグです。修正をお待ちください。
シリアル通信の通信タイミングがずれた/重なってしまったことが原因です。

ただこのエラーは、無視してもその一瞬だけ電圧が読めていないだけでそのままプログラムは続行します。

### 実行した直後にデコード関連のエラーが出て停止する
こちらも既知のバグです。修正をお待ちください。
上のエラーと同様、シリアル通信のタイミングがずれていたことにより実行直後にエラーが発生しています。

このエラーは当v1系プログラムにおいて各マイコンボード間の同期が不完全であるために発生するものです。
何度か実行すれば通るので Ctrl+Z で強制終了させ、もう一度実行してください。

### v2

### 速度算出が正常に動作しない
算出方法の問題で完璧な速度を出すことはできません。(どの程度正確かの検証を行っていません)
とはいえある程度の精度はありますので、「磁石が接近していない時の電圧(VTE_OFF)」「誤差として切り捨てて磁石が接近していないとする値(VTE_ERROR)(VTE_OFFと現在電圧の差分がこれ以下なら誤差とします)」等各種定数の値をお使いの環境に合わせたものにしていただければ、ある程度の速度を算出することは可能ですので、これらの設定を再度ご確認ください。(電圧等の値が計算上の理論値ではなく、実際に処理を行うボード上での値になっていることもご確認ください。)

あるいは回路等のに問題がある場合もございます。
ホール電圧のみをSerial.print関数で出力するなどを使用して監視する等でどういった現象が発生しているのかを確認し、原因を特定していただき、改善していただくことで正常な動作に近づきます。

## 諸注意
当方は本プログラムを利用した事によるいかなる損害も一切の責任を負いません。  

自己の責任の上で使用して下さい。  

改変等は自由に行っていただくことが可能です。

## 更新履歴
・v1.0.0 : リリース(20240100)

・v1.0.1 : 本来使う予定だったの並列処理で実行するプログラムの公開(20240200)

・v1.0.2 / v2.0.0 :v1系の追記 + v2系に関する情報の掲載(20241030)

## 更新予定

・v1.1.0 : 実行時などのいくつかのバグを修正予定

・v1.2.0 : v2系を進めるにあたって発覚したバグの修正や新仕様に対応予定

・v1.3.0 : 実行環境にRaspberry Piを使用した場合に、Raspberry Pi側からのモーターの動作に対応予定

・v2.x.x : Arduino一台のみでの実行が可能なものを公開予定(公開日未定)


<p align="right">(<a href="#top">トップへ</a>)</p>
